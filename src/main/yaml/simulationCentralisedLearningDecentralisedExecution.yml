incarnation: scafi

variables:
  width: &width { formula: 1000.0, language: application/x-scala }
  spacing: &spacing { formula: 100.0, language: application/x-scala }
  randomness: &randomness { formula: 25.0, language: application/x-scala }
  learningUpdate: &frequency { formula: 10 }
  random: &random
    min: 0
    max: 0
    step: 1
    default: 0

  range: &range
    formula: 400
    language: application/x-scala

  file: &file
    formula: >
      s"boids/condensed-${random.toString.toDouble.toInt}"
    language: application/x-scala

  environmentBox: &environmentBox
    formula: |
      import it.unibo.scripting._;
      it.unibo.learning.Box(width.as[Double], spacing.as[Double], randomness.as[Double])
    language: application/x-scala

  batchSize: &batchSize { formula: 32, language: application/x-scala }
  episodeLength: &episodeLength { formula: 100, language: application/x-scala }
  bufferSize: &bufferSize { formula: 100000, language: application/x-scala }
  windowSize: &windowSize { formula: 5, language: application/x-scala }
  actionSpaceEvaluated: &actionSpaceEvaluated
    #formula: "it.unibo.learning.abstractions.ActionSpace.create(5, List(0, 1, 1.5, 2.0, 2.5, 3.0))"
    formula: "it.unibo.learning.abstractions.ActionSpace.create(20, List(1), true)"
    language: application/x-scala

  neuralNet: &neuralNet
    formula: |
      import it.unibo.learning.network.torch.torch;
      torch.manual_seed(0)
      //torch.manual_seed(random.as[Double].toInt);
      import it.unibo.learning.network._;
      import it.unibo.scripting._;
      new MLPSpatial(
        hiddenSize = 128, 
        neigh = 5,
        actionSpace = actionSpaceEvaluated.as[List[Any]]
      )
    language: application/x-scala

  learner: &learner
    formula: |
      import it.unibo.learning.abstractions.DecayReference;
      import it.unibo.learning.agents.DeepQLearning;
      import it.unibo.learning.network.NeuralNetworkRL;
      import it.unibo.scripting._;
      new DeepQLearning(
        epsilon = DecayReference.exponentialDecay(0.05, 0.1).bounded(0.01),
        alpha = 0.001,
        gamma = 0.90,
        copyEach = 1000,
        referenceNet = neuralNet.as[NeuralNetworkRL]
      )
    language: application/x-scala
_constants:
  layerMolecule: &layerMolecule 'density'

seeds:
  scenario: *random
  simulation: *random

layers:
  - type: DensityMap
    parameters: [40]
    molecule: *layerMolecule

environment:
  type: Continuous2DEnvironment
  parameters: []
  global-programs:
    - time-distribution:
        type: DiracComb
        parameters: [ 0.0, 0.5 ]
      type: DensityMapFromFiles
      parameters: [ "boids", "condensed", 100, *episodeLength, *layerMolecule ]
    - time-distribution:
        type: DiracComb
        parameters: [ 0.2, 1.0 ]
      type: GlobalLearnerDecentralisedAgent
      parameters: [*layerMolecule, *learner, *bufferSize, *windowSize, *batchSize, *actionSpaceEvaluated, *episodeLength, *environmentBox, *frequency]

network-model:
  type: ClosestN #*connectionType
  parameters: [5]

_reactions:
  - program: &program
      - time-distribution:
          type: DiracComb
          parameters: [ 0.1, 1.0 ]
        type: Event
        actions:
          - type: RunScafiProgram
            parameters: [it.unibo.scafi.Explorer, 1.1 ]
      - program: send
deployments:
  type: Grid
  parameters: [0, 0, *width, *width, *spacing, *spacing, *randomness, *randomness]
  programs:
    - *program
export:
  - type: CSVExporter
    parameters:
      exportPath: "export"
      fileNameRoot: "simulation"
      interval: 1.0
    data:
      - time
      - type: CoverageExtractor
      - type: DensityExtractor